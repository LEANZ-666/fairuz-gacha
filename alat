#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <RTClib.h> 
#include <string.h> 

// --- Definisi Pin Hardware ---
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
#define SCREEN_ADDRESS 0x3C 

// Pin Tombol
#define UP_PIN 13       
#define DOWN_PIN 12     
#define OK_PIN 14       

// Pin BUZZER
#define BUZZER_PIN 5 

// --- DEBOUNCING PARAMETER ---
#define DEBOUNCE_DELAY 300 
unsigned long lastButtonPressTime = 0;

Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);
RTC_DS3231 rtc; 

// --- STRUKTUR DATA PR ---
#define MAX_PR_NAME_LENGTH 15 
#define MAX_PR_COUNT 5        

struct PR_Task {
    char name[MAX_PR_NAME_LENGTH];
    // Deadline Date
    uint8_t deadlineDay;      
    uint8_t deadlineMonth;    
    uint16_t deadlineYear;    
    // Alarm Date and Time
    uint8_t alarmDay;         
    uint8_t alarmMonth;       
    uint16_t alarmYear;       
    uint8_t alarmHour;
    uint8_t alarmMinute;
    uint8_t alarmSecond;
};

// --- DATA AWAL ---
PR_Task activePRs[MAX_PR_COUNT] = {
    {"Inggris", 15, 12, 2025, 14, 12, 2025, 10, 0, 0}, 
    {"PKN", 18, 12, 2025, 17, 12, 2025, 14, 30, 0},     
    {"MTK", 20, 12, 2025, 19, 12, 2025, 8, 0, 0}      
};
int numActivePRs = 3; 
int subjectSelection = 0; 

PR_Task tempNewPR;

const char* inputSubjects[] = {"MTK", "PKN", "B.Inggris", "B.Indo"};
const int numInputSubjects = 4;
int subjectInputSelection = 0;

// --- State Management ---
enum AppState {
    HOME_SCREEN,         
    MODE_SELECT_MENU,    
    FOCUS_MENU,          
    SUBJECT_SELECT,      
    TIMER_SET_MINUTES,   
    TIMER_SET_SECONDS,   
    TIMER_RUNNING,       
    TIMER_PAUSED,        
    TIME_UP_PR_DONE,     
    TIME_UP_ADD_TIME,    
    NORMAL_MODE,           
    NORMAL_DISPLAY,        
    SCHEDULE_DISPLAY,      
    INPUT_PR_SUBJECT,       
    INPUT_PR_DEADLINE_DAY, 
    INPUT_PR_DEADLINE_MONTH,
    INPUT_PR_DEADLINE_YEAR,
    INPUT_PR_ALARM_DAY,      
    INPUT_PR_ALARM_MONTH,    
    INPUT_PR_ALARM_YEAR,     
    INPUT_PR_ALARM_HOUR,
    INPUT_PR_ALARM_MINUTE,
    INPUT_PR_ALARM_SECOND,
    PR_SAVED_CONFIRMATION, 
    PR_DETAIL_DISPLAY,     
    ALARM_TRIGGERED        
};

AppState currentState = HOME_SCREEN;
int menuSelection = 0; 

// Timer Variables
unsigned long targetDuration = 0; 
unsigned long timerStartTime = 0; 
unsigned long timeRemaining = 0; 
bool isTimerActive = false;

// Editable Timer Variables
int setMinutes = 0; 
int setSeconds = 0; 

// Buzzer management
bool isBuzzerActive = false;
unsigned long buzzerStartTime = 0;
const unsigned long BUZZER_DURATION = 3000; // 3 detik

// --- FUNGSI BUZZER ---
void startBuzzer() {
    if (!isBuzzerActive) {
        buzzerStartTime = millis();
        isBuzzerActive = true;
    }
}

void stopBuzzer() {
    noTone(BUZZER_PIN);
    isBuzzerActive = false;
}

void handleBuzzer() {
    if (isBuzzerActive) {
        if (millis() - buzzerStartTime < BUZZER_DURATION) {
            // Pola bip sederhana
            unsigned long elapsed = millis() - buzzerStartTime;
            if ((elapsed / 200) % 2 == 0) { 
                 tone(BUZZER_PIN, 1000); 
            } else {
                 noTone(BUZZER_PIN);
            }
        } else {
            stopBuzzer();
        }
    }
    
    // Matikan buzzer jika state sudah tidak memerlukan bunyi
    if (currentState != ALARM_TRIGGERED && currentState != TIME_UP_PR_DONE) {
         stopBuzzer();
    }
}
// --- END FUNGSI BUZZER ---

void saveNewPR() {
    if (numActivePRs < MAX_PR_COUNT) {
        strcpy(activePRs[numActivePRs].name, tempNewPR.name);
        activePRs[numActivePRs].deadlineDay = tempNewPR.deadlineDay;
        activePRs[numActivePRs].deadlineMonth = tempNewPR.deadlineMonth;
        activePRs[numActivePRs].deadlineYear = tempNewPR.deadlineYear;
        activePRs[numActivePRs].alarmDay = tempNewPR.alarmDay; 
        activePRs[numActivePRs].alarmMonth = tempNewPR.alarmMonth; 
        activePRs[numActivePRs].alarmYear = tempNewPR.alarmYear; 
        activePRs[numActivePRs].alarmHour = tempNewPR.alarmHour;
        activePRs[numActivePRs].alarmMinute = tempNewPR.alarmMinute;
        activePRs[numActivePRs].alarmSecond = tempNewPR.alarmSecond;
        numActivePRs++;
        currentState = PR_SAVED_CONFIRMATION;
    } else {
        currentState = NORMAL_MODE; 
    }
}

// --- Setup ---
void setup() {
    Serial.begin(115199);
    
    Wire.begin(); 
    if (!display.begin(SSD1306_SWITCHCAPVCC, SCREEN_ADDRESS)) {
        Serial.println(F("SSD1306 alokasi gagal"));
        for (;;); 
    }
    if (!rtc.begin()) {
        Serial.println(F("RTC tidak ditemukan!"));
    } 
    pinMode(UP_PIN, INPUT_PULLUP);
    pinMode(DOWN_PIN, INPUT_PULLUP);
    pinMode(OK_PIN, INPUT_PULLUP);
    
    pinMode(BUZZER_PIN, OUTPUT); 
    digitalWrite(BUZZER_PIN, LOW); 

    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    display.println("MemoCase Ready!");
    display.display();
    delay(1500);
}

// Fungsi Tombol DENGAN debouncing
bool isButtonPressed(int pin) {
    if (digitalRead(pin) == LOW) {
        if ((millis() - lastButtonPressTime) > DEBOUNCE_DELAY) {
            lastButtonPressTime = millis(); 
            return true;
        }
    }
    return false;
}

void handleInput() {
    
    // --- Tombol UP (Pin 13) ---
    if (isButtonPressed(UP_PIN)) {
        if (currentState == HOME_SCREEN) {
            menuSelection = (menuSelection == 0) ? 1 : menuSelection - 1; 
        } else if (currentState == MODE_SELECT_MENU || currentState == FOCUS_MENU) {
            menuSelection = (menuSelection == 0) ? 2 : menuSelection - 1; 
        } else if (currentState == NORMAL_MODE) {
            menuSelection = (menuSelection == 0) ? 3 : menuSelection - 1; 
        } else if (currentState == SUBJECT_SELECT) { 
            subjectSelection = (numActivePRs > 0) ? (subjectSelection == 0 ? numActivePRs - 1 : subjectSelection - 1) : 0;
        } else if (currentState == NORMAL_DISPLAY) { 
            int maxSelection = numActivePRs > 0 ? numActivePRs : 0; 
            subjectSelection = (subjectSelection == 0) ? maxSelection : subjectSelection - 1;
        } else if (currentState == TIMER_SET_MINUTES) {
            setMinutes = (setMinutes < 59) ? setMinutes + 1 : 0; 
        } else if (currentState == TIMER_SET_SECONDS) {
            setSeconds = (setSeconds < 59) ? setSeconds + 1 : 0; 
        } else if (currentState == INPUT_PR_SUBJECT) {
            subjectInputSelection = (subjectInputSelection == 0) ? numInputSubjects - 1 : subjectInputSelection - 1;
        } else if (currentState == INPUT_PR_DEADLINE_DAY) {
            tempNewPR.deadlineDay = (tempNewPR.deadlineDay >= 31) ? 1 : tempNewPR.deadlineDay + 1; 
        } else if (currentState == INPUT_PR_DEADLINE_MONTH) {
            tempNewPR.deadlineMonth = (tempNewPR.deadlineMonth >= 12) ? 1 : tempNewPR.deadlineMonth + 1; 
        } else if (currentState == INPUT_PR_DEADLINE_YEAR) {
            tempNewPR.deadlineYear = (tempNewPR.deadlineYear >= 2099) ? 2024 : tempNewPR.deadlineYear + 1; 
        } else if (currentState == INPUT_PR_ALARM_DAY) { 
            tempNewPR.alarmDay = (tempNewPR.alarmDay >= 31) ? 1 : tempNewPR.alarmDay + 1;
        } else if (currentState == INPUT_PR_ALARM_MONTH) { 
            tempNewPR.alarmMonth = (tempNewPR.alarmMonth >= 12) ? 1 : tempNewPR.alarmMonth + 1;
        } else if (currentState == INPUT_PR_ALARM_YEAR) { 
            tempNewPR.alarmYear = (tempNewPR.alarmYear >= 2099) ? 2024 : tempNewPR.alarmYear + 1;
        } else if (currentState == INPUT_PR_ALARM_HOUR) {
            tempNewPR.alarmHour = (tempNewPR.alarmHour >= 23) ? 0 : tempNewPR.alarmHour + 1; 
        } else if (currentState == INPUT_PR_ALARM_MINUTE) {
            tempNewPR.alarmMinute = (tempNewPR.alarmMinute >= 59) ? 0 : tempNewPR.alarmMinute + 1; 
        } else if (currentState == INPUT_PR_ALARM_SECOND) {
            tempNewPR.alarmSecond = (tempNewPR.alarmSecond >= 59) ? 0 : tempNewPR.alarmSecond + 1; 
        } else if (currentState == TIME_UP_PR_DONE || currentState == TIME_UP_ADD_TIME) {
            menuSelection = (menuSelection == 0) ? 1 : 0; 
        }
    }
    
    // --- Tombol DOWN (Pin 12) ---
    else if (isButtonPressed(DOWN_PIN)) {
        if (currentState == HOME_SCREEN) { 
            menuSelection = (menuSelection == 1) ? 0 : menuSelection + 1; 
        } else if (currentState == MODE_SELECT_MENU || currentState == FOCUS_MENU) {
            menuSelection = (menuSelection == 2) ? 0 : menuSelection + 1; 
        } else if (currentState == NORMAL_MODE) {
            menuSelection = (menuSelection == 3) ? 0 : menuSelection + 1; 
        } else if (currentState == SUBJECT_SELECT) {
            subjectSelection = (numActivePRs > 0) ? (subjectSelection == (numActivePRs - 1) ? 0 : subjectSelection + 1) : 0;
        } else if (currentState == NORMAL_DISPLAY) { 
            int maxSelection = numActivePRs > 0 ? numActivePRs : 0;
            subjectSelection = (subjectSelection == maxSelection) ? 0 : subjectSelection + 1;
        } else if (currentState == TIMER_SET_MINUTES) {
            setMinutes = (setMinutes == 0) ? 59 : setMinutes - 1; 
        } else if (currentState == TIMER_SET_SECONDS) {
            setSeconds = (setSeconds == 0) ? 59 : setSeconds - 1; 
        } else if (currentState == INPUT_PR_SUBJECT) {
            subjectInputSelection = (subjectInputSelection == numInputSubjects - 1) ? 0 : subjectInputSelection + 1;
        } else if (currentState == INPUT_PR_DEADLINE_DAY) {
            tempNewPR.deadlineDay = (tempNewPR.deadlineDay <= 1) ? 31 : tempNewPR.deadlineDay - 1; 
        } else if (currentState == INPUT_PR_DEADLINE_MONTH) {
            tempNewPR.deadlineMonth = (tempNewPR.deadlineMonth <= 1) ? 12 : tempNewPR.deadlineMonth - 1; 
        } else if (currentState == INPUT_PR_DEADLINE_YEAR) {
            tempNewPR.deadlineYear = (tempNewPR.deadlineYear <= 2024) ? 2099 : tempNewPR.deadlineYear - 1; 
        } else if (currentState == INPUT_PR_ALARM_DAY) { 
            tempNewPR.alarmDay = (tempNewPR.alarmDay <= 1) ? 31 : tempNewPR.alarmDay - 1;
        } else if (currentState == INPUT_PR_ALARM_MONTH) { 
            tempNewPR.alarmMonth = (tempNewPR.alarmMonth <= 1) ? 12 : tempNewPR.alarmMonth - 1;
        } else if (currentState == INPUT_PR_ALARM_YEAR) { 
            tempNewPR.alarmYear = (tempNewPR.alarmYear <= 2024) ? 2099 : tempNewPR.alarmYear - 1;
        } else if (currentState == INPUT_PR_ALARM_HOUR) {
            tempNewPR.alarmHour = (tempNewPR.alarmHour <= 0) ? 23 : tempNewPR.alarmHour - 1; 
        } else if (currentState == INPUT_PR_ALARM_MINUTE) {
            tempNewPR.alarmMinute = (tempNewPR.alarmMinute <= 0) ? 59 : tempNewPR.alarmMinute - 1; 
        } else if (currentState == INPUT_PR_ALARM_SECOND) {
            tempNewPR.alarmSecond = (tempNewPR.alarmSecond <= 0) ? 59 : tempNewPR.alarmSecond - 1; 
        } else if (currentState == TIME_UP_PR_DONE || currentState == TIME_UP_ADD_TIME) {
            menuSelection = (menuSelection == 1) ? 0 : 1; 
        }
        
        if (currentState == TIMER_PAUSED) {
            isTimerActive = false;
            currentState = HOME_SCREEN;
            timeRemaining = 0; 
            targetDuration = 0; 
            menuSelection = 0; 
        }
    }

    // --- Tombol OK (Pin 14) ---
    else if (isButtonPressed(OK_PIN)) {
        stopBuzzer(); // Matikan buzzer
        if (currentState == HOME_SCREEN) {
            if (menuSelection == 0) { currentState = MODE_SELECT_MENU; } 
            menuSelection = 0; 
        } else if (currentState == MODE_SELECT_MENU) {
            if (menuSelection == 0) { currentState = FOCUS_MENU; } 
            else if (menuSelection == 1) { currentState = NORMAL_MODE; } 
            else if (menuSelection == 2) { currentState = HOME_SCREEN; } 
            menuSelection = 0; 
        } else if (currentState == NORMAL_MODE) { 
            if (menuSelection == 0) { currentState = SCHEDULE_DISPLAY; } 
            else if (menuSelection == 1) { 
                currentState = NORMAL_DISPLAY; 
                subjectSelection = 0; 
            } 
            else if (menuSelection == 2) { 
                currentState = INPUT_PR_SUBJECT; 
                tempNewPR = {};
                DateTime now = rtc.now();
                tempNewPR.deadlineDay = now.day();
                tempNewPR.deadlineMonth = now.month();
                tempNewPR.deadlineYear = now.year();
                tempNewPR.alarmDay = now.day();      
                tempNewPR.alarmMonth = now.month();  
                tempNewPR.alarmYear = now.year();    
            } else if (menuSelection == 3) { currentState = MODE_SELECT_MENU; }
            menuSelection = 0; 
        } else if (currentState == NORMAL_DISPLAY) { 
            if (numActivePRs > 0 && subjectSelection < numActivePRs) {
                currentState = PR_DETAIL_DISPLAY;
            } else if (subjectSelection == numActivePRs || numActivePRs == 0) {
                currentState = NORMAL_MODE;
                subjectSelection = 0; 
            }
        } else if (currentState == PR_DETAIL_DISPLAY) { 
            currentState = NORMAL_DISPLAY;
        } else if (currentState == SCHEDULE_DISPLAY || currentState == PR_SAVED_CONFIRMATION) { 
            currentState = NORMAL_MODE;
            menuSelection = 0;
        } else if (currentState == INPUT_PR_SUBJECT) {
            strcpy(tempNewPR.name, inputSubjects[subjectInputSelection]);
            currentState = INPUT_PR_DEADLINE_DAY;
        } else if (currentState == INPUT_PR_DEADLINE_DAY) {
            currentState = INPUT_PR_DEADLINE_MONTH;
        } else if (currentState == INPUT_PR_DEADLINE_MONTH) {
            currentState = INPUT_PR_DEADLINE_YEAR;
        } else if (currentState == INPUT_PR_DEADLINE_YEAR) {
            currentState = INPUT_PR_ALARM_DAY; 
        } else if (currentState == INPUT_PR_ALARM_DAY) {
            currentState = INPUT_PR_ALARM_MONTH;
        } else if (currentState == INPUT_PR_ALARM_MONTH) {
            currentState = INPUT_PR_ALARM_YEAR;
        } else if (currentState == INPUT_PR_ALARM_YEAR) {
            currentState = INPUT_PR_ALARM_HOUR;
        } else if (currentState == INPUT_PR_ALARM_HOUR) {
            currentState = INPUT_PR_ALARM_MINUTE;
        } else if (currentState == INPUT_PR_ALARM_MINUTE) {
            currentState = INPUT_PR_ALARM_SECOND;
        } else if (currentState == INPUT_PR_ALARM_SECOND) {
            saveNewPR(); 
        } else if (currentState == FOCUS_MENU) {
            if (menuSelection == 0) { 
                if (numActivePRs > 0) { 
                    currentState = SUBJECT_SELECT; 
                    subjectSelection = 0; 
                } 
                else { 
                    subjectSelection = 99; // Timer Saja (PR kosong)
                    currentState = TIMER_SET_MINUTES; setMinutes = 0; setSeconds = 0; 
                }
            } else if (menuSelection == 1) { 
                subjectSelection = 99; // Timer Saja (Dipilih manual)
                currentState = TIMER_SET_MINUTES; setMinutes = 0; setSeconds = 0; 
            } else if (menuSelection == 2) { currentState = MODE_SELECT_MENU; }
            menuSelection = 0; 
        } else if (currentState == SUBJECT_SELECT) {
            if (subjectSelection >= 0 && subjectSelection < numActivePRs) {
                // PR dipilih
                currentState = TIMER_SET_MINUTES; setMinutes = 0; setSeconds = 0; 
            }
        } else if (currentState == TIMER_SET_MINUTES) { currentState = TIMER_SET_SECONDS;
        } else if (currentState == TIMER_SET_SECONDS) {
            targetDuration = (unsigned long)(setMinutes * 60 + setSeconds) * 1000UL;
            if (targetDuration == 0) { 
                currentState = TIME_UP_PR_DONE; 
                startBuzzer(); 
            } 
            else { 
                timerStartTime = millis(); timeRemaining = targetDuration; isTimerActive = true; 
                currentState = TIMER_RUNNING; 
            }
        } else if (currentState == TIMER_PAUSED) {
            targetDuration = timeRemaining; timerStartTime = millis(); isTimerActive = true; currentState = TIMER_RUNNING; 
        } else if (currentState == TIMER_RUNNING) {
             unsigned long timeElapsed = millis() - timerStartTime;
             if (timeElapsed < targetDuration) { timeRemaining = targetDuration - timeElapsed; } 
             else { timeRemaining = 0; }
             isTimerActive = false; currentState = TIMER_PAUSED;
        } else if (currentState == TIME_UP_PR_DONE) {
            if (menuSelection == 0) { 
                if (subjectSelection >= 0 && subjectSelection < numActivePRs) {
                    for (int i = subjectSelection; i < numActivePRs - 1; i++) {
                        activePRs[i] = activePRs[i+1]; 
                    }
                    numActivePRs--; 
                }
                currentState = FOCUS_MENU; menuSelection = 0; 
            } else { 
                currentState = TIME_UP_ADD_TIME; 
                menuSelection = 0; 
            }
        } else if (currentState == TIME_UP_ADD_TIME) {
            if (menuSelection == 0) { 
                currentState = TIMER_SET_MINUTES; setMinutes = 0; setSeconds = 0;
            } else { 
                currentState = FOCUS_MENU; menuSelection = 0; 
            }
        } else if (currentState == ALARM_TRIGGERED) { 
            currentState = NORMAL_MODE; 
        }
    }
}

// FUNGSI Pengecekan Alarm
void checkAlarms() {
    if (currentState == TIMER_RUNNING || currentState == TIMER_PAUSED || currentState == ALARM_TRIGGERED || currentState == TIME_UP_PR_DONE) {
        return;
    }

    DateTime now = rtc.now();
    for (int i = 0; i < numActivePRs; i++) {
        PR_Task* pr = &activePRs[i];

        if (now.year() == pr->alarmYear &&
            now.month() == pr->alarmMonth &&
            now.day() == pr->alarmDay &&
            now.hour() == pr->alarmHour &&
            now.minute() == pr->alarmMinute &&
            now.second() == pr->alarmSecond) 
        {
            subjectSelection = i; 
            currentState = ALARM_TRIGGERED;
            startBuzzer(); 
            return; 
        }
    }
}


// --- Fungsi Display ---
void displayMenu() {
    display.clearDisplay();
    display.setTextSize(1);
    display.setTextColor(SSD1306_WHITE);
    display.setCursor(0, 0);
    
    DateTime now = rtc.now();
    
    char dateStr[20];
    sprintf(dateStr, "%02d/%02d/%d", now.day(), now.month(), now.year());
    
    const int TIMER_X = 10; 
    const int TIMER_Y = 30;
    const int INPUT_X = 10;
    const int INPUT_Y = 25; 

    switch (currentState) {
        case HOME_SCREEN:
            display.setTextSize(1);
            display.println("MemoCase"); 
            display.printf("Date: %s", dateStr); 
            display.setCursor(0, 20);
            display.setTextSize(2);
            display.printf("%02d:%02d:%02d\n", now.hour(), now.minute(), now.second()); 
            display.setTextSize(1);
            display.setCursor(0, 40); 
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Pilih Mode");
            display.setCursor(0, 50); 
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("WiFi Setup"); 
            break;

        case MODE_SELECT_MENU:
            display.println("--- Pilih Mode ---");
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Mode Fokus");
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("Mode Normal"); 
            display.print(menuSelection == 2 ? "> " : "  ");
            display.println("<< Kembali"); 
            break;
            
        case NORMAL_MODE:
            display.println("--- Mode Normal Menu ---");
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Jadwal");
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("Daftar PR"); 
            display.print(menuSelection == 2 ? "> " : "  ");
            display.println("Input PR");
            display.print(menuSelection == 3 ? "> " : "  ");
            display.println("<< Kembali"); 
            break;

        case NORMAL_DISPLAY: 
            display.println("--- Daftar PR ---");
            if (numActivePRs == 0) {
                display.setCursor(0, 20);
                display.setTextSize(1);
                display.println("Tidak ada PR");
                
                display.setCursor(0, 50);
                display.print(subjectSelection == 0 ? "> " : "  ");
                display.println("<< Kembali");
                
            } else {
                for (int i = 0; i < numActivePRs; i++) {
                    display.setCursor(0, 12 + i * 10);
                    display.print(subjectSelection == i ? "> " : "  ");
                    display.println(activePRs[i].name);
                }
                display.setCursor(0, 12 + numActivePRs * 10);
                display.print(subjectSelection == numActivePRs ? "> " : "  ");
                display.println("<< Kembali");
            }
            break;

        case PR_DETAIL_DISPLAY: 
            display.println("--- Detail PR ---");
            display.print("Mapel: "); display.println(activePRs[subjectSelection].name);
            display.print("DL: "); display.printf("%02d/%02d/%d\n", activePRs[subjectSelection].deadlineDay, activePRs[subjectSelection].deadlineMonth, activePRs[subjectSelection].deadlineYear);
            display.print("Alarm: "); display.printf("%02d/%02d/%d %02d:%02d:%02d\n", activePRs[subjectSelection].alarmDay, activePRs[subjectSelection].alarmMonth, activePRs[subjectSelection].alarmYear, activePRs[subjectSelection].alarmHour, activePRs[subjectSelection].alarmMinute, activePRs[subjectSelection].alarmSecond);
            display.setCursor(0, 54);
            display.println("(OK: Kembali ke Daftar)");
            break;
            
        case SCHEDULE_DISPLAY: 
            display.println("--- Jadwal Pelajaran ---");
            display.setCursor(0, 12);
            display.println("Senin: MTK");
            display.setCursor(0, 22);
            display.println("Selasa: PKN");
            display.setCursor(0, 32);
            display.println("Rabu: B. Inggris");
            display.setCursor(0, 42);
            display.println("Kamis: B. Indonesia");
            display.setCursor(0, 54);
            display.println("(OK: Kembali)");
            break;
            
        case INPUT_PR_SUBJECT:
            display.println("--- Input PR: Mapel ---");
            for (int i = 0; i < numInputSubjects; i++) { 
                display.setCursor(0, 12 + i * 10);
                display.print(subjectInputSelection == i ? "> " : "  ");
                display.println(inputSubjects[i]);
            }
            break;
            
        case INPUT_PR_DEADLINE_DAY:
            display.println("--- Deadline: Atur HARI (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf(">%02d/%02d/%4d", tempNewPR.deadlineDay, tempNewPR.deadlineMonth, tempNewPR.deadlineYear);
            break;

        case INPUT_PR_DEADLINE_MONTH:
            display.println("--- Deadline: Atur BULAN (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d/>%02d/%4d", tempNewPR.deadlineDay, tempNewPR.deadlineMonth, tempNewPR.deadlineYear);
            break;
            
        case INPUT_PR_DEADLINE_YEAR:
            display.println("--- Deadline: Atur TAHUN (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d/%02d/>%4d", tempNewPR.deadlineDay, tempNewPR.deadlineMonth, tempNewPR.deadlineYear);
            break;
            
        case INPUT_PR_ALARM_DAY:
            display.println("--- Alarm: Atur HARI (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf(">%02d/%02d/%4d", tempNewPR.alarmDay, tempNewPR.alarmMonth, tempNewPR.alarmYear);
            break;
            
        case INPUT_PR_ALARM_MONTH:
            display.println("--- Alarm: Atur BULAN (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d/>%02d/%4d", tempNewPR.alarmDay, tempNewPR.alarmMonth, tempNewPR.alarmYear);
            break;
            
        case INPUT_PR_ALARM_YEAR:
            display.println("--- Alarm: Atur TAHUN (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d/%02d/>%4d", tempNewPR.alarmDay, tempNewPR.alarmMonth, tempNewPR.alarmYear);
            break;

        case INPUT_PR_ALARM_HOUR:
            display.println("--- Alarm: Atur JAM (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf(">%02d:%02d:%02d", tempNewPR.alarmHour, tempNewPR.alarmMinute, tempNewPR.alarmSecond);
            break;

        case INPUT_PR_ALARM_MINUTE:
            display.println("--- Alarm: Atur MENIT (OK:Next) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d:>%02d:%02d", tempNewPR.alarmHour, tempNewPR.alarmMinute, tempNewPR.alarmSecond);
            break;
            
        case INPUT_PR_ALARM_SECOND:
            display.println("--- Alarm: Atur DETIK (OK:SIMPAN) ---");
            display.setTextSize(2);
            display.setCursor(INPUT_X, INPUT_Y);
            display.printf("%02d:%02d:>%02d", tempNewPR.alarmHour, tempNewPR.alarmMinute, tempNewPR.alarmSecond);
            break;
            
        case PR_SAVED_CONFIRMATION:
            display.println("--- PR Tersimpan! ---");
            display.print("Mapel: "); display.println(tempNewPR.name);
            display.print("DL: "); display.printf("%02d/%02d/%d\n", tempNewPR.deadlineDay, tempNewPR.deadlineMonth, tempNewPR.deadlineYear);
            display.print("Alarm: "); display.printf("%02d/%02d/%d %02d:%02d:%02d\n", tempNewPR.alarmDay, tempNewPR.alarmMonth, tempNewPR.alarmYear, tempNewPR.alarmHour, tempNewPR.alarmMinute, tempNewPR.alarmSecond);
            display.setCursor(0, 50);
            display.println("(OK: Menu Normal)");
            break;

        case FOCUS_MENU:
            display.println("--- Mode Fokus ---");
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Pilih PR");
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("Timer Saja");
            display.print(menuSelection == 2 ? "> " : "  ");
            display.println("<< Kembali"); 
            break;

        case SUBJECT_SELECT:
            display.println("--- Pilih PR (OK:Lanjut) ---");
            if (numActivePRs == 0) {
                 display.println("Tidak ada PR!");
                 display.println("Pilih Timer Saja");
            } else {
                 for (int i = 0; i < numActivePRs; i++) { 
                    display.print(subjectSelection == i ? "> " : "  ");
                    display.println(activePRs[i].name); 
                }
            }
            break;

        case TIMER_SET_MINUTES: { 
            display.println("--- Set Target: Menit (OK:Lanjut) ---");
            display.setTextSize(3);
            display.setCursor(TIMER_X, TIMER_Y); 
            display.printf(">%02d", setMinutes);
            display.print(":");
            display.printf("%02d", setSeconds);
            break;
        }

        case TIMER_SET_SECONDS: { 
            display.println("--- Set Target: Detik (OK:Mulai) ---"); 
            display.setTextSize(3);
            display.setCursor(TIMER_X, TIMER_Y); 
            display.printf("%02d", setMinutes);
            display.print(":>");
            display.printf("%02d", setSeconds);
            break;
        }

        case TIMER_RUNNING: { 
            unsigned long currentMillis = millis();
            unsigned long timeElapsed = currentMillis - timerStartTime; 
            if (isTimerActive && timeElapsed >= targetDuration) { 
                timeRemaining = 0; 
                isTimerActive = false; 
                currentState = TIME_UP_PR_DONE; 
                menuSelection = 0; 
                startBuzzer(); 
                break; 
            } 
            timeRemaining = targetDuration - timeElapsed;
            int currentMinutes = timeRemaining / 1000 / 60;
            int currentSeconds = (timeRemaining / 1000) % 60;

            display.println("--- TIMER AKTIF (OK: Jeda) ---");
            display.print("Fokus: ");
            
            // Pengecekan Aman
            if (subjectSelection >= 0 && subjectSelection < numActivePRs) { 
                display.println(activePRs[subjectSelection].name); 
            } else { 
                display.println("Timer Saja"); 
            } 
            
            display.setTextSize(3);
            display.setCursor(TIMER_X, TIMER_Y); 
            display.printf("%02d:%02d", currentMinutes, currentSeconds); 
            break;
        }

        case TIMER_PAUSED: {
             int currentMinutes = timeRemaining / 1000 / 60;
             int currentSeconds = (timeRemaining / 1000) % 60;
             display.println("--- TIMER JEDA (OK: Lanjut, DOWN: Stop) ---");
             display.print("Fokus: ");
             
             // Pengecekan Aman
             if (subjectSelection >= 0 && subjectSelection < numActivePRs) { 
                display.println(activePRs[subjectSelection].name); 
             } else { 
                display.println("Timer Saja"); 
             } 
             
             display.setTextSize(3);
             display.setCursor(TIMER_X, TIMER_Y); 
             display.printf("%02d:%02d", currentMinutes, currentSeconds); 
             break;
        }
            
        case TIME_UP_PR_DONE: 
            display.println("--- Waktu Habis! ---");
            // Pengecekan Aman
            if (subjectSelection >= 0 && subjectSelection < numActivePRs) {
                 display.print("PR ");
                 display.print(activePRs[subjectSelection].name);
                 display.println(" Selesai?");
            } else { display.println("Sesi Fokus Selesai?"); }
            
            display.setTextSize(2);
            display.setCursor(0, 30);
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Ya");
            display.setCursor(40, 30);
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("Tidak");
            break;
            
        case TIME_UP_ADD_TIME: 
            display.println("--- Lanjut Fokus? ---");
            display.println("Ingin menambah timer?");
            display.setTextSize(2);
            display.setCursor(0, 30);
            display.print(menuSelection == 0 ? "> " : "  ");
            display.println("Ya");
            display.setCursor(40, 30);
            display.print(menuSelection == 1 ? "> " : "  ");
            display.println("Tidak");
            break;

        case ALARM_TRIGGERED:
            display.println("!!! ALARM PENGINGAT !!!");
            display.setTextSize(2);
            display.setCursor(0, 20);
            display.print("Kerjakan PR ");
            display.println(activePRs[subjectSelection].name); 
            display.setTextSize(1);
            display.setCursor(0, 50);
            display.println("(OK: Selesai/Abaikan Alarm)");
            break;
            
        default:
            display.println("Error State");
            break;
    }

    display.display();
}

// --- Main Loop ---
void loop() {
    handleInput();
    checkAlarms(); 
    handleBuzzer(); 

    // Optimasi refresh display
    bool needsFastRefresh = isTimerActive || currentState == HOME_SCREEN || 
                            currentState == ALARM_TRIGGERED ||
                            currentState == TIME_UP_PR_DONE || 
                            (currentState >= INPUT_PR_DEADLINE_DAY && currentState <= PR_SAVED_CONFIRMATION) ||
                            currentState == PR_DETAIL_DISPLAY ||
                            currentState == TIMER_SET_MINUTES ||
                            currentState == TIMER_SET_SECONDS;

    if (needsFastRefresh) {
        if (millis() % 200 < 50) { 
             displayMenu();
        }
    } else {
        displayMenu();
    }
}
